# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

steps:
  - task: Bash@3
    displayName: Print environment variables
    inputs:
      targetType: 'inline'
      script: printenv
      workingDirectory: $(System.DefaultWorkingDirectory)

  - template: clone-src-with-deps.yaml


  - task: Gradle@2
    displayName: build and test dev ai-android service
    inputs:
      workingDirectory: '$(system.defaultWorkingDirectory)/AccessibilityInsightsForAndroidService'
      gradleWrapperFile: 'AccessibilityInsightsForAndroidService/gradlew'
      gradleOptions: '-Xmx3072m'
      options: -S
      javaHomeOption: 'JDKVersion'
      jdkVersionOption: '1.8'
      jdkArchitectureOption: 'x64'
      publishJUnitResults: true
      testResultsFiles: '**/TEST-*.xml'
      tasks: 'build'

  - task: Bash@3
    displayName: start emulator
    inputs:
      targetType: 'filePath'
      filePath: $(System.DefaultWorkingDirectory)/pipeline/start-emulator.sh
  
  - task: NodeTool@0
    inputs:
        versionSpec: '12.13.0'
    displayName: use node 12.13.0
    timeoutInMinutes: 2

  - script: npm install -g npm@6.11.1
    displayName: install npm 6.11.1
    timeoutInMinutes: 5

  - script: npm install yarn@1.17.3 -g
    displayName: install yarn as a global dependency
    timeoutInMinutes: 1

  - script: yarn install --frozen-lockfile
    displayName: install packages and dependencies
    timeoutInMinutes: 10

  - task: Bash@3
    displayName: Run appium script
    inputs:
      targetType: 'inline'
      script: node appium.js
      workingDirectory: $(System.DefaultWorkingDirectory)

  - task: Bash@3
    displayName: Print environment variables
    inputs:
      targetType: 'inline'
      script: printenv
      workingDirectory: $(System.DefaultWorkingDirectory)